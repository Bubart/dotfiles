#!/usr/bin/env bash
# vi: ft=bash

wofi_kill() {
    pkill -9 wofi
}

wofi_kill && exit 0

history="$HOME/.local/share/qalc.history"
if [ ! -f "$history" ]; then
    touch "$history"
fi

qalc -e "1 BTC" &

last_wofi=""
qalc_ret=""
while :; do
    qalc_hist=$(tac "$history" | head -5000)
    wofi_ret=$(wofi --sort-order=default --cache-file=/dev/null -d -p calc <<<"$qalc_hist")

    rtrn=$?

    if test "$rtrn" = "0"; then
        if [[ "$wofi_ret" =~ .*=.* ]]; then
            result=$(echo "$wofi_ret" | awk "{'print $NF'}")
            wl-copy "$result"
            exit 0
        else
            qalc_ret=$(qalc "$wofi_ret")
            last_wofi=$wofi_ret
            echo "$qalc_ret" >>"$history"
        fi
    else
        if [ -n "$last_wofi" ]; then
            result=$(qalc -t "$last_wofi")
            wl-copy "$result"
        fi
        exit 0
    fi
done
